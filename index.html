<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bacterial Cellulose Additive Calculator & Protocol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- ** VECTOR PDF LIBRARIES ** -->
    <!-- jsPDF Core Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable Plugin for vector tables -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* --- LAB STYLE THEME --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #1f2937; /* Darker gray text */
            margin: 0;
        }
        .main-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
            transition: filter 0.3s ease-in-out;
        }
        .main-container.blurred {
            filter: blur(8px);
            pointer-events: none;
        }
        .calculator-card {
            background-color: white;
            padding: 2.5rem;
            border-radius: 1rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 900px;
            text-align: center;
        }
        /* --- ACCESS GATE STYLES --- */
        #access-gate-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(17, 24, 39, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        #access-gate-modal {
            background-color: white;
            padding: 2.5rem;
            border-radius: 1rem;
            width: 100%;
            max-width: 450px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .title {
            font-size: 2.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #111827; /* Near black */
        }
        .subtitle {
            font-size: 1.125rem;
            color: #4b5563;
            margin-bottom: 2rem;
        }
        .input-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        @media (min-width: 768px) {
            .input-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .input-group {
            text-align: left;
        }
        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        input, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem; /* Sharper corners */
            font-size: 1rem;
            color: #1f2937;
            background-color: #f9fafb;
            transition: all 0.2s;
            box-sizing: border-box;
        }
        input:focus {
            outline: none;
            border-color: #3b82f6; /* Accent color on focus */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .btn {
            background-color: #374151; /* Dark gray button */
            color: white;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn:hover {
            background-color: #1f2937; /* Darker on hover */
        }
        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            box-shadow: none;
            text-align: center;
        }
        th, td {
            padding: 0.75rem; /* More padding for readability */
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #111827;
        }
        tbody tr:nth-child(odd) {
            background-color: white;
        }
        tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .note {
            margin-top: 1.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        .additive-input-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .protocol-content {
            text-align: left;
        }
        .protocol-content h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 2rem;
            margin-bottom: 0.5rem;
            color: #111827;
            border-bottom: 1px solid #d1d5db;
            padding-bottom: 0.25rem;
        }
        .protocol-content h4 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5rem;
            color: #374151;
        }
        .protocol-content p {
            margin-bottom: 1rem;
        }
        .protocol-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
        .protocol-table {
            max-width: 400px;
            margin: 1rem auto;
        }
        .protocol-table th,
        .protocol-table td {
            text-align: left;
        }
        .counter-input {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .counter-btn {
            background-color: #e5e7eb;
            color: #374151;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .counter-btn:hover {
            background-color: #d1d5db;
        }
        .toggle-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 32px;
            height: 16px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 16px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 12px;
            width: 12px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #3b82f6;
        }
        input:checked + .slider:before {
            transform: translateX(16px);
        }
        .input-obtrusive input {
            background-color: #f3f4f6;
            color: #9ca3af;
            border: 1px solid #e5e7eb;
        }
        .input-obtrusive input:focus {
            box-shadow: none;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body>

    <!-- Access Gate -->
    <div id="access-gate-overlay">
        <div id="access-gate-modal">
            <h1 class="title">Additives Calculator</h1>
            <p class="subtitle" style="font-size: 1rem;">Enter your email to use the calculator.</p>
            <div class="input-group mb-4">
                <input type="email" id="email-input" placeholder="your email address" class="text-center">
            </div>
            <button onclick="grantAccess()" class="btn w-full">Enter</button>
            <p class="note" style="font-size: 0.75rem;">Don't worry, your email is not stored.</p>
        </div>
    </div>

    <!-- Main Calculator Content -->
    <div id="main-container" class="main-container">
        <div class="calculator-card">
            <h1 class="title">Additive Calculator</h1>
            <p class="subtitle">Generate and calculate multiple samples automatically based on concentration ranges and dilution ratios.</p>

            <div id="calculator-tab" class="tab-content">
                <div class="border rounded-xl p-4 mb-4">
                    <div class="toggle-container">
                        <span>Change protocol variables</span>
                        <label class="switch">
                            <input type="checkbox" id="editToggle" onchange="toggleEdit()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="protocolVarsContainer" class="input-grid !grid-cols-2 mt-4 hidden">
                        <div class="input-group">
                            <label for="wetBCMass">Wet BC slurry volume (mL):</label>
                            <input type="number" id="wetBCMass" value="100" class="rounded-lg">
                        </div>
                        <div class="input-group">
                            <label for="bcCellulosePercent">Wet BC cellulose percentage (%):</label>
                            <input type="number" id="bcCellulosePercent" value="2" class="rounded-lg">
                        </div>
                    </div>
                </div>

                <div class="border rounded-xl p-4 mb-4">
                    <div class="input-grid">
                        <div class="input-group">
                            <label for="numAdditives">Number of additives:</label>
                            <div class="counter-input">
                                <div class="counter-btn" onclick="updateAdditiveCount(-1)">-</div>
                                <input type="number" id="numAdditives" value="1" min="0" onchange="generateAdditiveFields()" class="rounded-lg text-center" style="width: 4rem;">
                                <div class="counter-btn" onclick="updateAdditiveCount(1)">+</div>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="bcWaterRatios">BC:Water ratios (comma-separated, e.g., 1:0, 1:1, 1:4):</label>
                            <input type="text" id="bcWaterRatios" value="1:0, 1:1" class="rounded-lg">
                        </div>
                    </div>
                </div>

                <div id="additiveInputContainer" class="additive-input-container"></div>
                
                <button onclick="generateAndCalculate()" class="btn w-full mt-8">Generate Combinations & Calculate</button>

                <div id="percentageTableContainer" class="mt-8"></div>
                
                <div id="outputTableContainer"></div>
                
                <p class="note">This calculator assumes a slurry density of 1 g/mL.</p>
                
                <button id="showProtocolBtn" class="btn w-full mt-8" disabled onclick="showProtocol()">Show Protocol</button>
            </div>

            <div id="protocol-tab" class="tab-content hidden">
                <div class="protocol-content">
                    <h2 class="text-2xl font-bold mb-4 text-center">Protocol</h2>
                    <div id="protocol-output">
                        <p class="text-center text-gray-500">
                            Please generate a calculation first to see the protocol here.
                        </p>
                    </div>
                </div>
                <div class="flex space-x-4 mt-8 justify-center items-center">
                    <button class="btn w-1/2" onclick="showCalculator()">Back to Calculator</button>
                    <div class="flex items-center space-x-2">
                        <button class="btn" onclick="downloadProtocol()">Download</button>
                        <label for="downloadFileType" class="sr-only">File Type</label>
                        <select id="downloadFileType" class="px-4 py-2 border rounded-lg">
                            <option value="pdf" selected>PDF</option>
                            <option value="html">HTML</option>
                            <option value="txt">Text</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ACCESS GATE LOGIC ---
        const cookieName = 'lab_access_granted';
        const mainContainer = document.getElementById('main-container');
        const accessGateOverlay = document.getElementById('access-gate-overlay');

        function checkCookieOnLoad() {
            if (document.cookie.split(';').some((item) => item.trim().startsWith(cookieName + '='))) {
                showContent();
            } else {
                mainContainer.classList.add('blurred');
                accessGateOverlay.style.display = 'flex';
            }
        }

        function grantAccess() {
            const emailInput = document.getElementById('email-input');
            const emailValue = emailInput.value.toLowerCase();
            
            // Basic regex for email format validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(emailValue)) {
                showMessage("Enter a correct email address.");
                emailInput.value = ''; // Reset input field
                return;
            }

            const domainPart = emailValue.split('@')[1];

            // Check if domain contains 'lab' and ends with '.co'
            if (domainPart && domainPart.includes('lab') && domainPart.endsWith('.co')) {
                // Set cookie to expire in 90 days
                const d = new Date();
                d.setTime(d.getTime() + (90 * 24 * 60 * 60 * 1000));
                let expires = "expires=" + d.toUTCString();
                document.cookie = cookieName + "=true;" + expires + ";path=/";
                
                showContent();
            } else {
                showMessage("Enter a correct email address.");
                emailInput.value = ''; // Reset input field
            }
        }

        function showContent() {
            // Remove any leftover error messages upon success
            const existingMessageBoxes = document.querySelectorAll('.error-message-overlay');
            existingMessageBoxes.forEach(box => box.remove());

            mainContainer.classList.remove('blurred');
            accessGateOverlay.style.display = 'none';
            // Initial setup for the calculator once access is granted
            generateAdditiveFields(); 
        }

        // --- ORIGINAL CALCULATOR LOGIC ---
        let currentCalculation = {}; // To store data for filename generation

        function showMessage(message) {
            // First, remove any existing message boxes to prevent stacking
            const existingMessageBoxes = document.querySelectorAll('.error-message-overlay');
            existingMessageBoxes.forEach(box => box.remove());

            const messageBox = document.createElement('div');
            // Add a specific class for easy removal
            messageBox.className = 'error-message-overlay fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center z-50';
            messageBox.innerHTML = `
                <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full">
                    <p class="text-center text-lg font-semibold text-red-600 mb-4">${message}</p>
                    <button onclick="this.parentElement.parentElement.remove()" class="w-full bg-blue-500 text-white py-2 rounded-lg">OK</button>
                </div>
            `;
            document.body.appendChild(messageBox);
        }

        function showProtocol() {
            document.getElementById('calculator-tab').classList.add('hidden');
            document.getElementById('protocol-tab').classList.remove('hidden');
        }

        function showCalculator() {
            document.getElementById('protocol-tab').classList.add('hidden');
            document.getElementById('calculator-tab').classList.remove('hidden');
        }

        function toggleEdit() {
            const container = document.getElementById('protocolVarsContainer');
            container.classList.toggle('hidden');
        }

        function updateAdditiveCount(change) {
            const input = document.getElementById('numAdditives');
            let value = parseInt(input.value) + change;
            if (value < 0) value = 0;
            input.value = value;
            generateAdditiveFields();
        }

        function generateAdditiveFields() {
            const numAdditives = parseInt(document.getElementById('numAdditives').value);
            const container = document.getElementById('additiveInputContainer');
            container.innerHTML = '';
            
            if (isNaN(numAdditives) || numAdditives < 0) {
                showMessage("Please enter a valid number of additives.");
                document.getElementById('numAdditives').value = 0;
                return;
            }

            for (let i = 0; i < numAdditives; i++) {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-grid border rounded-xl p-4';
                inputGroup.innerHTML = `
                    <div class="input-group">
                        <label for="additiveName${i}">Additive ${i + 1} name:</label>
                        <input type="text" id="additiveName${i}" value="Additive ${i + 1}" class="rounded-lg">
                    </div>
                    <div class="input-group">
                        <label for="additiveConcentrations${i}">Concentrations (%, comma-separated):</label>
                        <input type="text" id="additiveConcentrations${i}" value="${i === 0 ? '5,10,15' : '0,2.5,5'}" class="rounded-lg">
                    </div>
                `;
                container.appendChild(inputGroup);
            }
        }

        function generateAndCalculate() {
            const wetBCMass = parseFloat(document.getElementById('wetBCMass').value);
            const bcCellulosePercent = parseFloat(document.getElementById('bcCellulosePercent').value);
            const bcWaterRatiosStr = document.getElementById('bcWaterRatios').value;
            const numAdditives = parseInt(document.getElementById('numAdditives').value);
            
            if (isNaN(wetBCMass) || wetBCMass <= 0 || isNaN(bcCellulosePercent) || bcCellulosePercent <= 0) {
                showMessage("Please enter valid positive numbers for Wet BC slurry volume and Wet BC cellulose percentage.");
                return;
            }

            const additiveData = [];
            for (let i = 0; i < numAdditives; i++) {
                const name = document.getElementById(`additiveName${i}`).value;
                const concentrations = document.getElementById(`additiveConcentrations${i}`).value.split(',').map(s => parseFloat(s.trim()));
                
                if (concentrations.some(isNaN) || concentrations.some(c => c < 0)) {
                    showMessage(`Invalid concentration values for ${name}. Please use comma-separated positive numbers.`);
                    return;
                }
                additiveData.push({ name, concentrations });
            }

            const bcWaterRatios = bcWaterRatiosStr.split(',').map(s => s.trim());
            if (bcWaterRatios.some(ratio => !ratio.includes(':'))) {
                showMessage("Please enter valid BC:Water ratios (e.g., 1:0) separated by commas.");
                return;
            }

            const combinations = generateCombinations(additiveData.map(a => a.concentrations));
            if (combinations.length === 0 && numAdditives > 0) {
                showMessage("Please enter at least one concentration for each additive.");
                return;
            }

            // Store data for filename generation
            currentCalculation = {
                additiveData: additiveData,
                combinations: combinations,
                bcWaterRatios: bcWaterRatios
            };
            
            renderPercentageTable(additiveData, combinations);
            renderFinalMassTable(wetBCMass, bcCellulosePercent, bcWaterRatios, additiveData, combinations);
            generateProtocol(wetBCMass, bcCellulosePercent, bcWaterRatios, additiveData, combinations);
            
            document.getElementById('showProtocolBtn').disabled = false;
        }

        function generateCombinations(arrays) {
            if (arrays.length === 0) return [[]];
            const result = [];
            const allCasesOfRest = generateCombinations(arrays.slice(1));
            for (let i = 0; i < arrays[0].length; i++) {
                for (let j = 0; j < allCasesOfRest.length; j++) {
                    result.push([arrays[0][i], ...allCasesOfRest[j]]);
                }
            }
            return result;
        }
        
        function createSampleName(additiveData, combo, ratio = '') {
            const nameParts = combo.map((val, i) => {
                const firstLetter = additiveData[i].name.trim().charAt(0).toUpperCase();
                return `${firstLetter}${val.toString().replace(/\.0+$/,'')}`;
            });
            const additiveName = nameParts.join('_');
            
            if (ratio) {
                return `${ratio}_${additiveName}`;
            } else {
                return additiveName;
            }
        }

        function renderPercentageTable(additiveData, combinations) {
            let tableHTML = `<h2 class="text-xl font-semibold mb-2 mt-8">Sample Combinations (%)</h2>`;
            tableHTML += `<p class="note">These are all the possible combinations based on your inputs.</p>`;
            tableHTML += `<table><thead><tr><th>Sample Name</th>`;
            additiveData.forEach(data => {
                tableHTML += `<th>${data.name} (%)</th>`;
            });
            tableHTML += `<th>BC (%)</th><th>Total (%)</th></tr></thead><tbody>`;

            combinations.forEach((combo) => {
                const totalAdditives = combo.reduce((sum, val) => sum + val, 0);
                const bcPercent = 100 - totalAdditives;
                const sampleName = createSampleName(additiveData, combo);
                
                tableHTML += `<tr><td>${sampleName}</td>`;
                combo.forEach(val => {
                    tableHTML += `<td>${val.toFixed(2)}</td>`;
                });
                tableHTML += `<td>${bcPercent.toFixed(2)}</td>`;
                tableHTML += `<td>100</td></tr>`;
            });
            tableHTML += '</tbody></table>';
            document.getElementById('percentageTableContainer').innerHTML = tableHTML;
        }

        function renderFinalMassTable(wetBCMass, bcCellulosePercent, bcWaterRatios, additiveData, combinations) {
            let fullTableHTML = '';
            
            let tableHTML = `
                <h2 class="text-xl font-semibold mb-2 mt-8">Final Mass Amounts (grams)</h2>
                <table><thead><tr><th>Sample Name</th>`;
            additiveData.forEach(data => {
                tableHTML += `<th>${data.name} (g)</th>`;
            });
            tableHTML += `<th>BC (g)</th><th>Total Dry Mass (g)</th></tr></thead><tbody>`;
            
            bcWaterRatios.forEach(ratioStr => {
                const parts = ratioStr.split(':').map(s => parseFloat(s.trim()));
                const bcPart = parts[0];
                const waterPart = parts[1];
                const totalParts = bcPart + waterPart;
                
                if (isNaN(bcPart) || isNaN(waterPart) || totalParts === 0) {
                    return;
                }

                const dilutedBCMass = wetBCMass * (bcPart / totalParts);
                const dryCelluloseMass = dilutedBCMass * (bcCellulosePercent / 100);

                combinations.forEach((combo) => {
                    const totalAdditives = combo.reduce((sum, val) => sum + val, 0);
                    const bcPercent = 100 - totalAdditives;
                    const sampleName = createSampleName(additiveData, combo, ratioStr);

                    if (bcPercent <= 0) {
                        tableHTML += `<tr><td>${sampleName}</td><td colspan="${additiveData.length + 2}">Not Possible - BC % is 0 or less</td></tr>`;
                        return;
                    }

                    const totalDryMass = dryCelluloseMass / (bcPercent / 100);

                    tableHTML += `<tr><td>${sampleName}</td>`;
                    combo.forEach(percent => {
                        const additiveMass = totalDryMass * (percent / 100);
                        tableHTML += `<td>${additiveMass.toFixed(2)}</td>`;
                    });
                    tableHTML += `<td>${dryCelluloseMass.toFixed(2)}</td>`;
                    tableHTML += `<td>${totalDryMass.toFixed(2)}</td>`;
                    tableHTML += '</tr>';
                });
            });
            
            tableHTML += '</tbody></table>';
            fullTableHTML += tableHTML;

            document.getElementById('outputTableContainer').innerHTML = fullTableHTML;
        }

        function generateProtocol(wetBCMass, bcCellulosePercent, bcWaterRatios, additiveData, combinations) {
            let protocolHTML = '';
            
            const uniqueDryCompositions = new Set();
            combinations.forEach(combo => {
                uniqueDryCompositions.add(JSON.stringify(combo));
            });

            protocolHTML += `
                <p><strong>Calculations:</strong></p>
                <p class="note">These values are for a ${wetBCMass} mL total final volume. If you need a different final volume, scale all values proportionally. This protocol assumes a slurry density of 1 g/mL.</p>
                
                <h3>Step 1: Prepare Master BC Slurry</h3>
                <p>The total dry mass of cellulose in ${wetBCMass} mL of your slurry is <strong>${(wetBCMass * (bcCellulosePercent / 100)).toFixed(2)} g</strong>. This is your starting point for all sample preparations.</p>

                <h3>Step 2: Prepare 1:0 Mixes</h3>
                <p>For each unique dry composition, create a 1:0 mix. This serves as a stock solution for all other dilutions.</p>
                <div class="space-y-4">
            `;
            
            const dryCelluloseMassForMasterBatch = wetBCMass * (bcCellulosePercent / 100);
            const wetSlurryMassForMasterBatch = dryCelluloseMassForMasterBatch / (bcCellulosePercent / 100);

            uniqueDryCompositions.forEach(comboStr => {
                const combo = JSON.parse(comboStr);
                const totalAdditives = combo.reduce((sum, val) => sum + val, 0);
                const bcPercent = 100 - totalAdditives;
                
                if (bcPercent <= 0) {
                    protocolHTML += `<p><strong>${createSampleName(additiveData, combo)}:</strong> Not possible - BC % is 0 or less. Cannot create a 1:0 mix.</p>`;
                    return;
                }

                const totalDryMass = dryCelluloseMassForMasterBatch / (bcPercent / 100);
                const sampleName = createSampleName(additiveData, combo);

                protocolHTML += `
                    <div class="protocol-section">
                        <table class="protocol-table my-4">
                            <thead>
                                <tr>
                                    <th colspan="2">1:0 mix for ${sampleName} samples</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>BC slurry</td>
                                    <td>${wetSlurryMassForMasterBatch.toFixed(2)} g</td>
                                </tr>
                `;
                combo.forEach((percent, i) => {
                    const additiveMass = totalDryMass * (percent / 100);
                    protocolHTML += `
                                <tr>
                                    <td>${additiveData[i].name}</td>
                                    <td>${additiveMass.toFixed(2)} g</td>
                                </tr>
                    `;
                });
                protocolHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            protocolHTML += `</div>`;

            // --- CONSOLIDATED DILUTION STEP ---
            if (bcWaterRatios.filter(r => r !== '1:0').length > 0) {
                protocolHTML += `
                    <h3 class="mt-8">Step 3: Prepare Final Dilutions</h3>
                    <p>For <strong>each</strong> 1:0 mix created in Step 2, use the following table to prepare the final diluted samples. The amounts are the same for all sample compositions.</p>
                    <table class="protocol-table">
                        <thead>
                            <tr>
                                <th>Final BC:Water Ratio</th>
                                <th>1:0 Mix (g)</th>
                                <th>Added Water (g)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                bcWaterRatios.forEach(ratioStr => {
                    const parts = ratioStr.split(':').map(s => parseFloat(s.trim()));
                    const bcPart = parts[0];
                    const waterPart = parts[1];
                    const totalParts = bcPart + waterPart;

                    if (ratioStr === '1:0' || isNaN(bcPart) || isNaN(waterPart) || totalParts === 0) {
                        return; // Skip the 1:0 mix as it's the stock
                    }

                    const mixMassNeeded = wetBCMass * (bcPart / totalParts);
                    const addedWaterMass = wetBCMass - mixMassNeeded;

                    protocolHTML += `
                            <tr>
                                <td>${ratioStr}</td>
                                <td>${mixMassNeeded.toFixed(2)}</td>
                                <td>${addedWaterMass.toFixed(2)}</td>
                            </tr>
                    `;
                });

                protocolHTML += `
                        </tbody>
                    </table>
                `;
            }

            document.getElementById('protocol-output').innerHTML = protocolHTML;
        }

        function downloadProtocol() {
            const fileType = document.getElementById('downloadFileType').value;
            const protocolContentElement = document.getElementById('protocol-output');

            // --- Generate Filename ---
            const generateFilename = (extension) => {
                if (!currentCalculation.combinations || currentCalculation.combinations.length === 0) {
                    return `lab_protocol.${extension}`; // Fallback for safety
                }

                const numCombos = currentCalculation.combinations.length;
                const numRatios = currentCalculation.bcWaterRatios.length;
                
                let additiveNames = "Control";
                if (currentCalculation.additiveData && currentCalculation.additiveData.length > 0) {
                    // Sanitize names for filename
                    additiveNames = currentCalculation.additiveData.map(a => a.name.replace(/[^a-zA-Z0-9]/g, '')).join('-');
                }

                return `Protocol_${additiveNames}_${numCombos}c-${numRatios}r.${extension}`;
            };


            if (fileType === 'pdf') {
                // --- NATIVE VECTOR PDF GENERATION ---
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const margin = 15;
                const contentWidth = doc.internal.pageSize.getWidth() - margin * 2;
                let y = margin; // Y-cursor for the current page

                const checkPageBreak = (elementHeight) => {
                    if (y + elementHeight > doc.internal.pageSize.getHeight() - margin) {
                        doc.addPage();
                        y = margin;
                    }
                };

                const elements = Array.from(protocolContentElement.children);
                
                // PDF Styles for this theme (Forced Black & White)
                const styles = {
                    h3Color: '#000000',
                    pColor: '#000000',
                    tableHeadFill: '#f0f0f0',
                    tableHeadText: '#000000'
                };

                for (const element of elements) {
                    const tagName = element.tagName.toUpperCase();
                    
                    if (tagName === 'H3') {
                        checkPageBreak(12);
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(16);
                        doc.setTextColor(styles.h3Color);
                        doc.text(element.innerText, margin, y);
                        y += 12;
                    } else if (tagName === 'P') {
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(10);
                        doc.setTextColor(styles.pColor);
                        const textLines = doc.splitTextToSize(element.innerText, contentWidth);
                        const textHeight = textLines.length * 5; // Approximate height
                        checkPageBreak(textHeight);
                        doc.text(textLines, margin, y);
                        y += textHeight + 2;
                    } else if (tagName === 'DIV' && element.classList.contains('space-y-4')) {
                        const tableSections = Array.from(element.children);
                        for(const section of tableSections) {
                            const tableEl = section.querySelector('table');
                            if (tableEl) {
                                doc.autoTable({
                                    html: tableEl,
                                    startY: y,
                                    margin: { left: margin, right: margin },
                                    theme: 'grid',
                                    headStyles: {
                                        fillColor: styles.tableHeadFill,
                                        textColor: styles.tableHeadText,
                                        fontStyle: 'bold'
                                    }
                                });
                                y = doc.autoTable.previous.finalY + 6;
                            }
                        }
                    } else if (tagName === 'TABLE') {
                        doc.autoTable({
                            html: element,
                            startY: y,
                            margin: { left: margin, right: margin },
                            theme: 'grid',
                            headStyles: {
                                fillColor: styles.tableHeadFill,
                                textColor: styles.tableHeadText,
                                fontStyle: 'bold'
                            }
                        });
                        y = doc.autoTable.previous.finalY + 6;
                    }
                }
                
                doc.save(generateFilename('pdf'));

            } else if (fileType === 'html') {
                const protocolContent = protocolContentElement.innerHTML;
                const createFullHTML = (content) => `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <title>Bacterial Cellulose Additive Protocol</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.5; color: #333333; box-sizing: border-box; padding: 20px; }
                        h1, h3, h4 { color: #111827; font-weight: bold; }
                        h1 { font-size: 24pt; text-align: center; margin-bottom: 20px; }
                        h3 { font-size: 16pt; margin-top: 25px; border-bottom: 1px solid #dddddd; padding-bottom: 5px; }
                        h4 { font-size: 14pt; margin-top: 20px; color: #374151; }
                        p { margin-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; margin-bottom: 15px; }
                        .protocol-table { max-width: 500px; margin-left: auto; margin-right: auto; }
                        th, td { padding: 8px; text-align: left; border: 1px solid #cccccc; }
                        th { background-color: #f9fafb; font-weight: bold; }
                        .note { font-style: italic; color: #6b7280; font-size: 9pt; }
                    </style>
                </head>
                <body>
                    <h1>Bacterial Cellulose Additive Protocol</h1>
                    ${content}
                </body>
                </html>
                `;
                const fullHTML = createFullHTML(protocolContent);
                const blob = new Blob([fullHTML], { type: 'text/html' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = generateFilename('html');
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);

            } else if (fileType === 'txt') {
                // Rebuild the text content with spacing between elements
                const textParts = [];
                const topLevelElements = Array.from(protocolContentElement.children);
                
                for (const element of topLevelElements) {
                    // If the element is the container for the Step 2 tables, process its children individually
                    if (element.classList.contains('space-y-4')) {
                        const nestedElements = Array.from(element.children);
                        nestedElements.forEach(nestedEl => textParts.push(nestedEl.innerText));
                    } else {
                        // Otherwise, add the top-level element (h3, p, final table) directly
                        textParts.push(element.innerText);
                    }
                }

                const protocolText = textParts.join('\n\n');
                const blob = new Blob([protocolText], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = generateFilename('txt');
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            }
        }

        // Run the access check when the document is fully loaded
        document.addEventListener('DOMContentLoaded', checkCookieOnLoad);
    </script>

</body>
</html>


